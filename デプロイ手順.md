# 🚨 エラー解決：デプロイ手順

## エラーの原因

「通信エラー: Unexpected token '<', "<!doctype "... is not valid JSON」

このエラーは、**POSTリクエストに対してHTMLが返ってきている**ことを示しています。

### 主な原因
1. **Webアプリが正しくデプロイされていない**
2. **古いデプロイバージョンがキャッシュされている**
3. **デプロイ設定で「自分」として実行されていない**

---

## ✅ 完全な解決手順

### ステップ1: コードを最新版に更新

既に [code.gs](code.gs) は最新版に更新済みです。以下の改善を追加しました：
- `doPost(e)` のnullチェック強化
- フロントエンドのエラーハンドリング改善
- 詳細なコンソールログ追加

### ステップ2: スプレッドシートを開く

1. このURLを開く:
   ```
   https://docs.google.com/spreadsheets/d/1VuUKbvUEfML2n3-Y4qycdeQR8KwMUUghp9CdhPGAeNXe68GGVTKkGhnP
   ```

2. 以下の3つのシートが存在することを確認:
   - `研修生マスタ`
   - `打刻記録`
   - `課題完了記録`

### ステップ3: Apps Scriptエディタを開く

1. スプレッドシートで「拡張機能」→「Apps Script」
2. 既存のコードをすべて削除
3. 更新した [code.gs](code.gs) の内容をすべてコピー＆ペースト
4. **保存**（Ctrl + S）

### ステップ4: LINEアクセストークンを設定

code.gs の9行目を編集：

```javascript
const LINE_CHANNEL_ACCESS_TOKEN = 'YOUR_LINE_CHANNEL_ACCESS_TOKEN_HERE';
```

↓ 実際のトークンに変更

```javascript
const LINE_CHANNEL_ACCESS_TOKEN = 'あなたのLINEチャネルアクセストークン';
```

**保存**（Ctrl + S）

### ステップ5: 既存のデプロイを削除（重要！）

1. Apps Scriptエディタで「デプロイ」→「デプロイを管理」
2. 既存のデプロイがあれば、右側の「⋮」→「デプロイを削除」
3. 削除を確認

### ステップ6: 新しいデプロイを作成

1. 「デプロイ」→「新しいデプロイ」をクリック

2. 「種類の選択」で ⚙️アイコン をクリック

3. **「ウェブアプリ」を選択**（これが最重要！）

4. 以下の設定を**正確に**行う:
   ```
   説明: 出退勤打刻アプリ v2
   次のユーザーとして実行: 自分（あなたのメールアドレス）
   アクセスできるユーザー: 全員
   ```

5. 「デプロイ」ボタンをクリック

### ステップ7: 権限を承認

1. 「アクセスを承認」をクリック
2. Googleアカウントを選択
3. 「このアプリは確認されていません」が表示されたら:
   - 「詳細」をクリック
   - 「（プロジェクト名）に移動」をクリック
   - すべての権限に「許可」

### ステップ8: デプロイURLをコピー

デプロイ完了画面に表示される「ウェブアプリ」のURLをコピー:

```
https://script.google.com/macros/s/XXXXXXXXXXXXX/exec
```

### ステップ9: APP_URLを更新

code.gs の21行目を編集：

```javascript
const APP_URL = 'https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec';
```

↓ コピーしたURLに変更

```javascript
const APP_URL = 'https://script.google.com/macros/s/XXXXXXXXXXXXX/exec';
```

**保存**（Ctrl + S）

### ステップ10: 再デプロイ

1. 「デプロイ」→「デプロイを管理」
2. 鉛筆アイコン（編集）をクリック
3. 「バージョン」を「新バージョン」に変更
4. 「デプロイ」をクリック

### ステップ11: テスト

1. デプロイされたURLをブラウザで開く
2. **F12キーを押して開発者ツールを開く**（Consoleタブ）
3. 「出勤」ボタンをクリック
4. コンソールに以下のようなログが表示されることを確認:
   ```
   Sending request: {action: "start"}
   Response status: 200
   Content-Type: application/json
   Result: {success: true, message: "出勤打刻が完了しました"}
   ```

---

## 🔍 トラブルシューティング

### エラー1: まだ「Unexpected token '<'」が出る

**原因**: ブラウザキャッシュ

**解決法**:
1. Ctrl + Shift + R で強制リロード
2. または、シークレットモードで開く

### エラー2: 「リクエストデータが不正です」

**原因**: デプロイ設定が「ウェブアプリ」になっていない

**解決法**:
- ステップ5から再度実行
- 「種類の選択」で必ず「ウェブアプリ」を選ぶ

### エラー3: 「研修生情報が見つかりません」

**原因**: スプレッドシートの「研修生マスタ」シートにデータがない

**解決法**:
1. スプレッドシートを開く
2. 「研修生マスタ」シートに以下を入力:

| 研修生ID | 氏名 | ステータス |
|---------|------|-----------|
| user01  | あなたの名前 | 進行中 |

### エラー4: コンソールに「403 Forbidden」

**原因**: 権限が正しく設定されていない

**解決法**:
- デプロイ設定で「次のユーザーとして実行: 自分」になっているか確認
- 再度権限承認を行う

---

## 📝 チェックリスト

デプロイ前に以下を確認してください:

- [ ] code.gs が最新版に更新されている
- [ ] LINE_CHANNEL_ACCESS_TOKEN が設定されている
- [ ] スプレッドシートに3つのシートが存在する
- [ ] 「研修生マスタ」に user01 のデータが入っている
- [ ] デプロイ種類が「ウェブアプリ」になっている
- [ ] 「次のユーザーとして実行: 自分」が選択されている
- [ ] 「アクセスできるユーザー: 全員」が選択されている
- [ ] 権限を承認した
- [ ] APP_URL が正しいデプロイURLに更新されている
- [ ] 新バージョンで再デプロイした

---

## 💡 デバッグ方法

問題が解決しない場合、以下を確認してください:

### 1. Apps Scriptのログを確認

1. Apps Scriptエディタで「実行」→「doGet」を選択
2. 「実行ログ」を確認
3. エラーメッセージがあれば、そこに原因が記載されています

### 2. ブラウザのコンソールログを確認

1. アプリを開いてF12
2. Consoleタブを開く
3. ボタンをクリック
4. 赤いエラーメッセージを確認

### 3. ネットワークタブを確認

1. F12 → Networkタブ
2. ボタンをクリック
3. POSTリクエストをクリック
4. Response タブで実際のレスポンスを確認

---

この手順で必ず動作します！わからないことがあれば、コンソールログのスクリーンショットを共有してください。
